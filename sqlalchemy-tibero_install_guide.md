# SQLAlchemy-tibero 환경 구축

## 목차

- [1. 개요](#개요)
- [2. python 및 pip 설치](#python-및-pip-설치)
- [3. unixodbc 설치](#unixodbc-설치)
- [4. virtualenv 환경 구축](#virtualenv-환경-구축-(선택-사항))
- [5. SQLAlchemy-tibero 설치](#SQLAlchemy-tibero-설치)
- [6. tbdsn 설정](#tbdsn-설정)
- [7. SQLAlchemy-tibero 동작 테스트](#SQLAlchemy-tibero-동작-테스트)
- [8. TroubleShooting](#TroubleShooting)
- [9. NOTE](#NOTE)


## 개요

위 문서는 linux 환경에서 SQLAlchemy Tibero Dialect 설치 방법에 대해 다루고 있습니다.

Tibero Dialect 는 ODBC 를 사용하는 pyodbc 드라이버를 통해 구현이 되어 있습니다.

Tibero Dialect 를 사용하기 위해서 아래와 같은 요구 사항을 충족해야 합니다.

- python 3.8 이상
- pyodbc 5.x 이상
- sqlalchemy 2.0 이상
- Tibero 및 Tibero ODBC Driver 7.x 이상

* 참고 : Tibero 및 Tibero ODBC 드라이버는 7.2 버전 기준으로 개발되어 해당 버전에서 호환성이 가장 높습니다.


## python 및 pip 설치

```bash
sudo apt-get install python3

sudo apt-get install python3-pip
```



## unixodbc 설치

```bash
sudo apt-get install unixodbc
```



이후에 odbc.ini와 odbcinst.ini 파일에 다음과 같이 설정해주어야 합니다.

각 파일은 /etc/odbc.ini 및 /etc/odbcinst.ini 에 존재합니다.



odbc.ini 예시
```
[Tibero7]	# DSN 명
Driver          = Tibero7Driver	# odbcinst.ini 파일에 설정한 Driver Name
Description     = Tibero7 ODBC Datasource	# DataSource 에 대한 설명
SID             = tibero		# tbdsn.tbr 파일에 설정한 SID
User            = tibero	# 접속할 사용자 계정의 이름
Password        = tmax		# 접속할 사용자 계정의 패스워드
```


odbcinst.ini 예시
```
[Tibero7Driver]	# Driver Name
Description     = ODBC Driver for Tibero 7	# Driver 에 대한 설명
Driver          = /media/tibero/tibero7/client/lib/jar/libtbodbc.so	# Driver 라이브러리 파일의 실제 경로
```


추가적으로 ODBC 디버깅 설정을 위해선 odbc.ini 파일에 다음 내용을 추가해야 합니다.

```
[ODBC]
Trace           = 1
TraceFile       = /tmp/odbc.trace
```


## virtualenv 환경 구축 (선택 사항)

virtualenv 환경을 구축하면 독립적인 환경에서 원하는 패키지 버전을 사용할 수 있습니다.

```bash
# 패키지 설치
sudo apt install python3-virtualenv

# 가상 환경 생성 (폴더가 생성됩니다.)
virtualenv sqlalchemy-tibero-env

# 가상 환경 시작
source sqlalchemy-tibero-env/bin/activate
```

가상환경을 나가려면 터미널에 다음 명령어를 입력하면 됩니다.

```bash
deactivate
```


## SQLAlchemy-tibero 설치

아직 pypi 테스트 서버에만 배포된 상태라 현재는 다음 명령어로 설치할 수 있습니다.

```bash
python -m pip install --index-url https://test.pypi.org/simple/ --extra-index-url https://pypi.org/simple sqlalchemy-tibero[pyodbc]
```


pypi Tmax 계정 생성 후 pypi 공식 사이트에 배포되면 다음 명령어로 설치할 수 있습니다.

```bash
pip install sqlalchemy-tibero[pyodbc]
```


## tbdsn 설정

Tibero ODBC Library 는 $TB_HOME/client/config/tbdsn.tbr 에 있는 DSN을 읽습니다.

따라서 TB_HOME 환경변수 설정과 tbdsn.tbr 설정을 필요로 합니다.

tbdsn.tbr 설정 예시입니다.

```
#-------------------------------------------------
# /media/tibero/tibero7/client/config/tbdsn.tbr
# Network Configuration File.
# Generated by gen_tip.sh at Mon Jul  1 10:36:04 UTC 2024
tibero=(	# SID
	(INSTANCE=(HOST=localhost)	# Tibero 서버의 IP 주소
		(PORT=12345)		# Tibero 서버의 포트 번호 
		(DB_NAME=tibero)	# 데이터베이스의 이름
	)
)
```

TB_HOME 환경변수 설정을 위해서 python 코드 실행 시 다음과 같은 코드를 추가해야 합니다.

```python
import os

os.environ["TB_HOME"] = "/media/tibero/tibero7"	# Tibero가 설치된 경로
```

혹은 해당 환경을 쉘에서 추가해야 합니다.

```bash
export TB_HOME="/media/tibero/tibero7"
```

## SQLAlchemy-tibero 동작 테스트


설치가 완료되면 다음 코드를 통해 SQLAlchemy Tibero Dialect 를 사용할 수 있습니다.

```python
from sqlalchemy import create_engine
engine = create_engine("tibero+pyodbc://@your_dsn")
```


1. 유저 클래스를 통해 테이블을 생성하고 인스턴스를 추가하는 코드입니다.

```python
from sqlalchemy import create_engine, Column, Integer, String, Sequence

from sqlalchemy.ext.declarative import declarative_base

from sqlalchemy.orm import sessionmaker

# SQLAlchemy Base 클래스 생성
Base = declarative_base()

# ORM 테이블 클래스 정의
class User(Base):
    __tablename__ = 'users'
    id = Column(Integer, Sequence('user_id_seq'), primary_key=True)
    name = Column(String(50))
    fullname = Column(String(50))
    nickname = Column(String(50))
    
    def __repr__(self):
        return f"<User(id={self.id}, name='{self.name}', fullname='{self.fullname}', nickname='{self.nickname}')>"

# SQLAlchemy 엔진 생성
engine = create_engine('tibero+pyodbc://tibero:tmax@Tibero7')

# 데이터베이스에 테이블 생성
Base.metadata.create_all(engine)

# 세션 생성
Session = sessionmaker(bind=engine)
session = Session()

# 새로운 사용자 인스턴스 생성
new_user = User(name='John', fullname='John Doe', nickname='johnny')

# 세션을 통해 데이터베이스에 사용자 추가
session.add(new_user)
session.commit()

# 세션 종료
session.close()

print("테이블이 성공적으로 생성되고 데이터가 추가되었습니다.")

# 세션을 사용하여 데이터베이스와 상호작용
session = Session()

# 모든 사용자 조회
users = session.query(User).all()

# 각 사용자 정보 출력
for user in users:
    print(f'ID: {user.id}, Name: {user.name}, Fullname: {user.fullname}, Nickname: {user.nickname}')

# 세션 종료
session.close()
```

---

## TroubleShooting

### 1. pyodbc 4.x 및 SQLAlchemy 1.x.x 설치 문제

아래 명령어로 pyodbc와 SQLAlchemy의 설치 여부 및 버전을 확인합니다

```bash
pip list 
```

pyodbc 버전이 5.0 미만이거나 SQLAlchemy 버전이 2.0 미만인 경우 문제가 발생할 수 있습니다.
지원되지 않는 버전을 삭제하고 다음 명령어를 통해 Tibero Dialect를 다시 설치해주시기 바랍니다.

```bash
pip uninstall pyodbc
pip uninstall sqlalchemy
```

---

## NOTE

- Tibero Dialect는 iodbc를 지원하지 않습니다. 이는 pyodbc가 unixodbc를 공식으로 지원하기 때문입니다.
